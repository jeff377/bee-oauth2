name: Publish NuGet Packages

on:
  push:
    tags:
      - 'v*'  # åªæœ‰æ¨é€ tagï¼ˆä¾‹å¦‚ v1.2.3ï¼‰æ™‚æ‰æœƒè§¸ç™¼

jobs:
  publish:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x
          6.0.x

    - name: Add MSBuild to PATH (for .NET Framework)
      uses: microsoft/setup-msbuild@v1.3

    - name: Restore dependencies
      run: dotnet restore --locked-mode

    - name: Build Bee.OAuth2 projects
      run: |
        dotnet build src/Bee.OAuth2/Bee.OAuth2.csproj --configuration Release --no-restore
        dotnet build src/Bee.OAuth2.AspNet/Bee.OAuth2.AspNet.csproj --configuration Release --no-restore
        dotnet build src/Bee.OAuth2.AspNetCore/Bee.OAuth2.AspNetCore.csproj --configuration Release --no-restore
        dotnet build src/Bee.OAuth2.WinForms/Bee.OAuth2.WinForms.csproj --configuration Release --no-restore
        dotnet build src/Bee.OAuth2.Desktop/Bee.OAuth2.Desktop.csproj --configuration Release --no-restore

    - name: Pack Bee.OAuth2 projects
      run: |
        dotnet pack src/Bee.OAuth2/Bee.OAuth2.csproj --configuration Release --output ./nupkgs
        dotnet pack src/Bee.OAuth2.AspNet/Bee.OAuth2.AspNet.csproj --configuration Release --output ./nupkgs
        dotnet pack src/Bee.OAuth2.AspNetCore/Bee.OAuth2.AspNetCore.csproj --configuration Release --output ./nupkgs
        dotnet pack src/Bee.OAuth2.WinForms/Bee.OAuth2.WinForms.csproj --configuration Release --output ./nupkgs
        dotnet pack src/Bee.OAuth2.Desktop/Bee.OAuth2.Desktop.csproj --configuration Release --output ./nupkgs


    - name: Push to NuGet
      run: |
        Get-ChildItem -Path ./nupkgs -Filter *.nupkg | ForEach-Object {
          dotnet nuget push $_.FullName --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        }

  release:
    needs: publish # ğŸ‘ˆ ç¢ºä¿ç™¼ä½ˆ NuGet å®Œæˆå¾Œæ‰é€²è¡Œ Release
    runs-on: ubuntu-latest

    steps:
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          è‡ªå‹•ç™¼ä½ˆ NuGet å¥—ä»¶ï¼š
          - Bee.OAuth2
          - Bee.OAuth2.AspNet
          - Bee.OAuth2.AspNetCore
          - Bee.OAuth2.WinForms
          - Bee.OAuth2.Desktop

          å¦‚éœ€å®‰è£è«‹è‡³ NuGet.org æŸ¥è©¢å°æ‡‰ç‰ˆæœ¬ã€‚

